{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="card p-4 shadow-sm mb-4 border-0">
        <h4 class="text-primary"><i class="fas fa-shopping-cart me-2"></i> Nova Venda (Saída de Material)</h4>
        <hr>
        <form action="{{ url_for('registrar_venda') }}" method="POST" class="row g-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="col-md-3">
                <label class="form-label fw-bold">Material para Venda</label>
                <select name="id_produto" id="select_produto_venda" class="form-select" required onchange="calcularVenda()">
                    <option value="" disabled selected>Selecione o material</option>
                    {% for p in produtos %}
                    <option value="{{ p.id }}" data-preco="{{ p.preco_quilo }}" data-estoque="{{ p.estoque_atual }}">
                        {{ p.nome }} (Disp: {{ p.estoque_atual }}kg)
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Comprador (Cliente)</label>
                <select name="id_cliente" class="form-select" required>
                    {% for c in clientes %}
                    <option value="{{ c.id }}">{{ c.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold">Peso a Vender (kg)</label>
                <input type="number" step="0.01" name="peso" id="input_peso_venda" class="form-control" required oninput="calcularVenda()">
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold">Total da Venda (R$)</label>
                <input type="number" step="0.01" name="valor_total" id="input_total_venda" class="form-control" required>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold">Recebido?</label>
                <select name="pago" class="form-select">
                    <option value="sim">Sim (À vista)</option>
                    <option value="nao" selected>Não (Conta Corrente)</option>
                </select>
            </div>

            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary px-5">Finalizar Venda</button>
            </div>
        </form>
    </div>

    <div class="card p-4 shadow-sm border-0">
        <h5><i class="fas fa-history me-2"></i> Últimas Vendas Realizadas</h5>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cliente</th>
                    <th>Material</th>
                    <th>Peso</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for v in vendas %}
                <tr>
                    <td>{{ v.id }}</td> <td>{{ v.id_cliente }}</td> <td>{{ v.id_produto }}</td>
                    <td class="text-danger">{{ v.peso|abs }} kg</td>
                    <td class="fw-bold">R$ {{ "%.2f"|format(v.valor_total) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function calcularVenda() {
    const select = document.getElementById('select_produto_venda');
    const inputPeso = document.getElementById('input_peso_venda');
    const inputTotal = document.getElementById('input_total_venda');

    const opcao = select.options[select.selectedIndex];
    const preco = opcao.getAttribute('data-preco');
    const estoque = opcao.getAttribute('data-estoque');
    const peso = inputPeso.value;

    if (preco && peso) {
        // Alerta visual se tentar vender mais do que tem
        if (parseFloat(peso) > parseFloat(estoque)) {
            inputPeso.classList.add('is-invalid');
        } else {
            inputPeso.classList.remove('is-invalid');
        }

        const total = parseFloat(preco) * parseFloat(peso);
        inputTotal.value = total.toFixed(2);
    }
}
</script>
{% endblock %}